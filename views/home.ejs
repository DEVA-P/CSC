<!DOCTYPE html>
<html>
  <title>BRANCH DASHBOARD</title>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css" />
  <link
    rel="stylesheet"
    href="https://fonts.googleapis.com/css?family=Raleway"
  />
  <link
    rel="stylesheet"
    href="https://fonts.googleapis.com/icon?family=Material+Icons"
  />
  <style>
    body,
    h1,
    h2,
    h3,
    h4,
    h5 {
      font-family: "Raleway", sans-serif;
    }

    /* .add-icon{
    position: fixed;
    bottom: 2.5%;
    right: 2.5%;
    z-index: 2; 
}*/

    /* Add padding to containers */
    .container {
      padding: 16px;
      background-color: white;
    }

    .newCustomer .material-icons {
      font-size: 2.8rem;
      color: rgb(95, 95, 255);
      cursor: pointer;
    }

    .newProduct .material-icons {
      font-size: 2.8rem;
      color: cadetblue;
      cursor: pointer;
    }

    .newCategory .material-icons {
      font-size: 2.8rem;
      color: rgb(255, 66, 66);
      cursor: pointer;
    }

    button {
      background-color: transparent;
      border: none;
    }

    /* Full-width input fields */
    .userInput,
    .tableInput {
      width: 100%;
      padding: 15px;
      margin: 5px 0 22px 0;
      display: inline-block;
      border: none;
      background: #f1f1f1;
    }

    .userInput:focus,
    .tableInput:focus {
      background-color: #ddd;
      outline: none;
    }

    .tableInput {
      margin: -7px;
    }

    input::-webkit-outer-spin-button,
    input::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    input[type="number"] {
      -moz-appearance: textfield;
    }

    #billQuantity {
      margin: 0;
      border: 1px solid #ddd;
    }

    .registerbtn {
      background-color: #04aa6d;
      color: white;
      padding: 16px 20px;
      margin: 8px 0;
      border: none;
      cursor: pointer;
      width: 100%;
      opacity: 0.9;
    }

    .alert {
      padding: 20px;
      background-color: #f44336;
      color: white;
      position: fixed;
      width: 100%;
      top: 75px;
      text-align: center;
      z-index: 1;
    }

    .closebtn {
      margin-left: 15px;
      color: white;
      font-weight: bold;
      float: right;
      font-size: 22px;
      line-height: 20px;
      cursor: pointer;
      transition: 0.3s;
    }

    .closebtn:hover {
      color: black;
    }

    /* search bar */
    #myInput {
      background-image: url("/img/search-icon.png");
      background-size: 20px 20px;
      background-position: 10px 12px;
      background-repeat: no-repeat;
      width: 100%;
      font-size: 16px;
      padding: 12px 20px 15px 40px;
      border: 1px solid #ddd;
      margin: 0;
      margin-bottom: 12px;
    }

    .content {
      position: relative;
    }

    #myUL {
      list-style-type: none;
      padding: 0;
      margin: 0;
      position: absolute;
    }

    #myUL li a {
      border: 1px solid #ddd;
      margin-top: -1px;
      /* Prevent double borders */
      background-color: #f6f6f6;
      padding: 12px;
      text-decoration: none;
      font-size: 18px;
      color: black;
      display: block;
      cursor: pointer;
    }

    #myUL li a:hover:not(.header) {
      background-color: #b5c9ff;
    }

    .alter {
      font-size: 25px;
    }

    .delete:hover {
      color: red;
      cursor: pointer;
    }

    label {
      float: left;
      margin-right: 10%;
    }

    .highlight {
      background-color: lightblue;
      font-weight: bold;
    }

    .tax {
      position: relative;
    }

    .tax input {
      width: 80%;
    }

    .tax select {
      padding: 15px;
      margin: 5px 0 22px 0;
      border: none;
      background: #f1f1f1;
    }
  </style>

  <body class="w3-light-grey">
    <div class="w3-bar w3-black w3-padding-large">
      <a href="#" class="w3-bar-item w3-button rounded"
        ><b> <%=user.branchId%> - BRANCH'S DASHBOARD </b>
      </a>

      <div class="w3-dropdown-hover w3-right">
        <button class="w3-button w3-black rounded">
          <b> <%=user.userName%> </b>
        </button>

        <img
          class="mr-2 w3-circle"
          src="img/avatar.jpg"
          width="40"
          height="40"
          alt="avatar"
        />

        <div
          class="w3-dropdown-content w3-bar-block w3-border"
          style="right: 0"
        >
          <a
            onclick="document.getElementById('edit-profile').style.display='block'"
            class="w3-bar-item w3-button w3-padding-large"
            >Edit profile</a
          >
          <!-- #region for edit profile of user-->
          <div id="edit-profile" class="w3-modal">
            <div class="w3-modal-content w3-card-4">
              <form action="#">
                <header class="w3-container w3-teal">
                  <span
                    onclick="document.getElementById('edit-profile').style.display='none'"
                    class="w3-button w3-display-topright w3-xlarge"
                    >&times;</span
                  >
                  <h2>EDIT PROFILE</h2>
                </header>
                <div class="container">
                  <label for="name"><b>Username</b></label>
                  <input
                    class="userInput"
                    type="text"
                    name="name"
                    id="name"
                    required
                  />
                  <!-- <label for="about"><b>Description</b></label>
                <input type="text" placeholder="Enter course description" name="about" id="about" required> -->
                  <button type="submit" class="registerbtn">
                    Edit profile
                  </button>
                </div>
              </form>
            </div>
          </div>
          <a
            onclick="logoutHandler()"
            class="w3-bar-item w3-button w3-padding-large"
            >Log out</a
          >
        </div>
      </div>
      <a href="/bill" class="w3-bar-item w3-button w3-right"
        ><b>Billings</b></a
      >
      <button class="newCustomer w3-right" onclick="newCustomer();">
        <span class="material-icons"> add_circle </span>
      </button>
      <a href="/customer" class="w3-bar-item w3-button w3-right"
        ><b>Customer</b></a
      >
      <button class="newProduct w3-right" onclick="newProduct();">
        <span class="material-icons"> add_circle </span>
      </button>
      <a href="/product" class="w3-bar-item w3-button w3-right"
        ><b>Product</b></a
      >
      <button class="newCategory w3-right" onclick="newCategory();">
        <span class="material-icons"> add_circle </span>
      </button>
      <a href="/category" class="w3-bar-item w3-button w3-right"
        ><b>Category</b></a
      >

      <div class="w3-clear"></div>
    </div>

    <!-- <div class="w3-content" style="max-width: 1400px">
      <header class="w3-container w3-center w3-padding-32">
        <h1><b>PRODUCTS PRESENT</b></h1> 
        <p>Welcome to the CSC SHOP</p>
      </header>
    </div> -->

    <div class="w3-row w3-container content">
      <br /><br />
      <div class="w3-threequarter">
        <!-- onkeyup="addProductToList(this)" -->
        <div class="w3-container">
          <div class="w3-third">
            <input
              autofocus
              type="text"
              id="myInput"
              class="userInput"
              placeholder="Search for names.."
              title="Type in a name"
            />

            <ul id="myUL">
              <% product.forEach(product=> { %>

              <li>
                <a
                  onclick="addToProductSearch(`<%=product.productid%>@<%=product.productcode%>@<%=product.productname%>@<%=product.costprice%>@<%=product.saleprice%>@<%=product.mrp%>@<%=product.discount%>@<%=product.taxperc%>@<%=product.unit%>@<%=product.status%>@<%=product.tax_type%>`)"
                >
                  <%=product.productname%>
                </a>
              </li>

              <%})%>
            </ul>
          </div>
          <div class="w3-quarter">
            <input
              type="number"
              class="userInput"
              placeholder="Quantity"
              name="billQuantity"
              id="billQuantity"
              required
            />
          </div>
          <div class="w3-third">
            <button
              class="w3-button w3-red w3-ripple w3-padding-16"
              onclick="addProductToTable()"
            >
              <b>ADD</b>
            </button>
            <button
              class="w3-button w3-green w3-right w3-ripple w3-padding-16"
              onclick="billProducts()"
            >
              <b>BILL</b>
            </button>
          </div>
        </div>

        <div class="w3-row">
          <div class="w3-col container s12" id="courses-container">
            <!-- #region student details-->
            <% if(success===1){ %>
            <div class="w3-content" style="max-width: 1400px">
              <div class="w3-container">
                <h1><b>BILL DETAILS</b></h1>
                <!-- <input
                autofocus
                class="w3-input w3-border w3-padding"
                type="text"
                placeholder="Search for product names / product codes.."
                id="myInput"
                onkeyup="myFunction()"
              /> -->

                <table class="w3-table w3-margin-top" id="myTable">
                  <tr>
                    <th style="width: 40%">PRODUCT NAME</th>
                    <th style="width: 8%">QUANTITY</th>
                    <th style="width: 10%">RATE</th>
                    <th style="width: 8%">DISCOUT</th>
                    <th style="width: 8%">TAX</th>
                    <th style="width: 7%">TAX_type</th>
                    <th style="width: 10%">AMOUNT</th>
                    <th style="width: 10%">DELETE</th>
                  </tr>
                </table>
              </div>
              <% } else{%>
              <h1>Something went wrong <%=err%>!</h1>
              <%} %>
            </div>
          </div>
        </div>
      </div>

      <div class="w3-container w3-quarter">
        <div class="w3-container w3-khaki w3-round-xlarge">
          <h5>CUSTOMER NAME / MOBILE</h5>
          <div class="w3-container w3-center">
            <input
              type="text"
              placeholder="Customer Name / mobile"
              name="customer_name"
              class="userInput"
              id="customer_name"
              required
            />
          </div>
          <h5>DATE</h5>
          <div class="w3-container w3-center">
            <input
              type="date"
              placeholder="date"
              name="date"
              class="userInput"
              id="date"
              required
            />
          </div>
        </div>
        <br />
        <div class="w3-container w3-khaki w3-round-xlarge">
          <h5>SUB TOTAL</h5>
          <div class="subtotal w3-container w3-center">
            <h1 id="subtotal"><b>0.00</b></h1>
          </div>
          <h5>ADJUSTMENT</h5>
          <div class="subtotal w3-container w3-center">
            <input
              type="number"
              placeholder="Adjustment"
              name="adjustment"
              class="userInput"
              onkeyup="updateSubtotal(0)"
              id="adjustment"
              required
            />
          </div>
          <h5>TOTAL</h5>
          <div class="total w3-container w3-center">
            <h1 id="total"><b>0.00</b></h1>
          </div>
        </div>
      </div>
    </div>

    <!--ALERT -->
    <div class="alert" id="aler">
      <span class="closebtn" onclick="this.parentElement.style.display='none';"
        >&times;</span
      >
      <div id="text"></div>
    </div>
    <!--ALERT -->

    <!-- newProduct -->
    <div id="addNewProductModal" class="w3-modal">
      <div class="w3-modal-content w3-card-4">
        <form id="course_form" onsubmit="productFormSubmitHandler(event);">
          <header class="w3-container w3-teal">
            <span
              onclick="document.getElementById('addNewProductModal').style.display='none'"
              class="w3-button w3-display-topright w3-xlarge"
              >&times;</span
            >
            <h2 id="form-title">ADD NEW PRODUCT</h2>
          </header>
          <div class="container">
            <div class="w3-cell-row">
              <div class="w3-container w3-half">
                <label for="product_name"><b>Product Name</b></label>
                <input
                  type="text"
                  placeholder="Product Name"
                  name="product_name"
                  class="userInput"
                  id="product_name"
                  required
                />
              </div>

              <div class="w3-container w3-half">
                <label for="print_name"><b>Print Name</b></label>
                <input
                  type="text"
                  placeholder="Print Name"
                  class="userInput"
                  name="print_name"
                  required
                />
              </div>
            </div>
            <div class="w3-cell-row">
              <div class="w3-container w3-half">
                <label for="product_code"><b>Product Code</b></label>
                <input
                  type="text"
                  placeholder="product_code"
                  name="product_code"
                  id="product_code"
                  class="userInput"
                  required
                />
              </div>

              <div class="w3-container w3-half">
                <label for="mrp"><b>MRP Price</b></label>
                <input
                  type="number"
                  placeholder="MRP"
                  name="mrp"
                  id="mrp"
                  class="userInput"
                  required
                />
              </div>
            </div>
            <div class="w3-cell-row">
              <div class="w3-container w3-half">
                <label for="cost_price"><b>Cost Price</b></label>
                <input
                  type="number"
                  placeholder="Cost Price"
                  name="cost_price"
                  class="userInput"
                  id="cost_price"
                  required
                />
              </div>

              <div class="w3-container w3-half">
                <label for="selling_price"><b>Selling Price</b></label>
                <input
                  type="number"
                  placeholder="Selling Price"
                  name="selling_price"
                  class="userInput"
                  id="selling_price"
                  required
                />
              </div>
            </div>
            <div class="w3-cell-row">
              <div class="w3-container w3-half tax">
                <label for="tax"><b>Tax Perc</b></label>
                <input
                  type="number"
                  placeholder="Tax Perc"
                  name="tax"
                  class="userInput"
                  id="tax"
                  required
                />
                <select
                  class="w3-dropdown-hover w3-right"
                  name="tax_type"
                  id="tax_type"
                >
                  <option class="w3-bar-item w3-button" value="1">%</option>
                  <option class="w3-bar-item w3-button" value="2">₹</option>
                </select>
              </div>

              <div class="w3-container w3-half discount">
                <label for="discount"><b>Discount</b></label>
                <input
                  type="number"
                  placeholder="Discount"
                  name="discount"
                  id="discount"
                  class="userInput"
                  required
                />
              </div>
            </div>
            <div class="w3-container w3-half">
              <label for="unit"><b>Unit</b></label>
              <input
                type="text"
                placeholder="Unit"
                name="unit"
                class="userInput"
                id="unit"
                required
              />
            </div>
            <button type="submit" id="form-button" class="registerbtn rounded">
              Submit
            </button>
          </div>

          <footer class="w3-container w3-teal">
            <p>please verify before submission</p>
          </footer>
        </form>
      </div>
    </div>
    <!-- newProduct -->

    <!-- newCategory -->
    <div id="addNewCategoryModal" class="w3-modal">
      <div class="w3-modal-content w3-card-4">
        <form id="category_form" onsubmit="categoryFormSubmitHandler(event);">
          <header class="w3-container w3-teal">
            <span
              onclick="document.getElementById('addNewCategoryModal').style.display='none'"
              class="w3-button w3-display-topright w3-xlarge"
              >&times;</span
            >
            <h2 id="form-title">ADD NEW CATEGORY</h2>
          </header>
          <div class="container">
            <label for="category_name"><b>Category Name</b></label>
            <input
              type="text"
              placeholder="Category Name"
              name="category_name"
              class="userInput"
              id="category_name"
              required
            />
            <label for="category_code"><b>Search Code</b></label>
            <input
              type="text"
              placeholder="Search Code for Category"
              name="category_code"
              id="category_code"
              class="userInput"
            />

            <button type="submit" id="form-button" class="registerbtn rounded">
              Submit
            </button>
          </div>

          <footer class="w3-container w3-teal">
            <p>please verify before submission</p>
          </footer>
        </form>
      </div>
    </div>
    <!-- newCategory -->
  </body>
  <script>
    var aler = document.getElementById("aler");
    aler.style.display = "none";
    let type = "new";
    let selectedResult = 0;
    let sub_total = 0.0;
    let total = 0.0;
    let activeChildrenCount = 0;
    const modal1 = document.getElementById("edit-profile");
    const modal2 = document.getElementById("addNewProductModal");
    const modal3 = document.getElementById("addNewCategoryModal");
    const table = document.getElementById("myTable");
    const searchList = document.getElementById("myUL");
    searchList.style.display = "none";
    const activeProductId = [];

    function productFormSubmitHandler(event) {
      event.preventDefault();
      if (type === "new") addNewProduct();
      else if (type === "edit") editProduct();
    }

    function addNewProduct() {
      const product_name = document.querySelector(
        "[name='product_name']"
      ).value;
      const print_name = document.querySelector("[name='print_name']").value;
      const product_code = document.querySelector(
        "[name='product_code']"
      ).value;
      const cost_price = document.querySelector("[name='cost_price']").value;
      const selling_price = document.querySelector(
        "[name='selling_price']"
      ).value;
      const mrp = document.querySelector("[name='mrp']").value;
      const discount = document.querySelector("[name='discount']").value;
      const tax = document.querySelector("[name='tax']").value;
      const unit = document.querySelector("[name='unit']").value;
      const tax_type = document.querySelector("[name='tax_type']").value;

      const data = {
        product_name,
        print_name,
        product_code,
        cost_price,
        selling_price,
        mrp,
        discount,
        tax,
        unit,
        tax_type,
      };
      console.log(data);

      fetch("/product/addNewProduct", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify(data),
      })
        .then(handleError)
        .then((res) => {
          console.log(res);
          modal2.style.display = "none";
          aler.style.display = "block";
          aler.style.background = "green";
          text.style.display = "block";
          msg = "<strong>Success </strong>   Product Added Successfully";
          text.innerHTML = msg;
          setTimeout(() => {
            location.reload();
          }, 2000);
        })
        .catch((err) => {
          console.log(err);
          modal2.style.display = "none";
          aler.style.display = "block";
          text.style.display = "block";
          msg = "<strong>Danger !</strong>    " + err;
          text.innerHTML = msg;
        });
    }

    function categoryFormSubmitHandler(event) {
      event.preventDefault();
      if (type === "new") addNewCategory();
      else if (type === "edit") editCategory();
    }

    function addNewCategory() {
      const categoryname = document.querySelector(
        "[name='category_name']"
      ).value;
      const categorycode = document.querySelector(
        "[name='category_code']"
      ).value;

      const data = {
        categoryname,
        categorycode,
      };

      fetch("/category/addNewCategory", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify(data),
      })
        .then(handleError)
        .then((res) => {
          modal3.style.display = "none";
          aler.style.display = "block";
          aler.style.background = "green";
          text.style.display = "block";
          msg = "<strong>Success </strong>   Category Added Successfully";
          text.innerHTML = msg;
          setTimeout(() => {
            location.reload();
          }, 2000);
        })
        .catch((err) => {
          modal3.style.display = "none";
          aler.style.display = "block";
          text.style.display = "block";
          msg = "<strong>Danger !</strong>    " + err;
          text.innerHTML = msg;
        });
    }

    function newProduct() {
      document.getElementById("addNewProductModal").style.display = "block";
      //type = 'new';
      document.getElementById("course_form").reset();
      //formButton.innerText = 'Submit';
      //formTitle.innerText = 'COURSE CREATION';
    }
    function newCategory() {
      document.getElementById("addNewCategoryModal").style.display = "block";
      //type = 'new';
      document.getElementById("category_form").reset();
      //formButton.innerText = 'Submit';
      //formTitle.innerText = 'COURSE CREATION';
    }

    async function handleError(res) {
      if (!res.ok) {
        res = await res.json();
        throw new Error(res.msg);
      } else return res.json();
    }

    function logoutHandler() {
      fetch("/logout")
        .then(handleError)
        .then((res) => {
          window.location.href = "/login";
        })
        .catch((err) => {
          console.log(err);
        });
    }

    let currentProduct = "";
    let productSelector = 0;

    function calcAmount(rate, discountPercent, taxPercent, quantity, taxType) {
      let discount = (rate * discountPercent) / 100;
      let discountedRate = rate - discount;
      let tax = 0;
      if (taxType == 1) {
        tax = (discountedRate * taxPercent) / 100;
      } else if (taxType == 2) {
        tax = taxPercent;
      }
      let amount = parseFloat(discountedRate) + parseFloat(tax);
      amount = amount * quantity;
      return amount.toFixed(2);
    }

    function addProductToTable() {
      //alert(currentProduct);
      let inputField = document.getElementById("myInput");
      let quantity = document.getElementById("billQuantity").value;

      if (quantity == "") {
        aler.style.display = "block";
        text.style.display = "block";
        msg = "<strong>Danger !</strong>  Plse enter the Quantity!!!";
        text.innerHTML = msg;
        return;
      }
      if (productSelector == 0) {
        aler.style.display = "block";
        text.style.display = "block";
        inputField.value = "";
        msg =
          "<strong>Danger !</strong>  Plse Select the right product from the suggestion of available product list!!!";
        text.innerHTML = msg;
        return;
      }
      let product_detail = currentProduct.split("@");
      let row = table.insertRow();
      let cell1 = row.insertCell(0);
      let cell2 = row.insertCell(1);
      let cell3 = row.insertCell(2);
      let cell4 = row.insertCell(3);
      let cell5 = row.insertCell(4);
      let cell6 = row.insertCell(5);
      let cell7 = row.insertCell(6);
      let cell8 = row.insertCell(7);

      let productId = product_detail[0];
      let product_name = product_detail[2];
      let rate = parseFloat(product_detail[4]);
      let discountPercent = parseFloat(product_detail[6]);
      let taxPercent = parseFloat(product_detail[7]);
      let taxType = parseFloat(product_detail[10]);
      if (product_name == undefined || rate == NaN) {
        aler.style.display = "block";
        text.style.display = "block";
        msg =
          "<strong>Danger !</strong>   Something went wrong continue in 1 second !!";
        text.innerHTML = msg;
        setTimeout(() => {
          location.reload();
        }, 2000);
        return;
      }

      //Amount calculation
      let amount = calcAmount(
        rate,
        discountPercent,
        taxPercent,
        quantity,
        taxType
      );
      activeProductId.push(productId);

      cell1.innerHTML = `<input class="tableInput" type="text" placeholder="Product Name"  onkeyup="alterTable(this)" value="${product_name}" name="bill_product_name" id="bill_product_name" disabled/>`;
      cell2.innerHTML = `<input  class="tableInput" type="number" placeholder="Quantity" onkeyup="alterTable(this)" value="${quantity}" name="bill_quantity" id="bill_quantity"/>`;
      cell3.innerHTML = `<input  class="tableInput" type="number" placeholder="Rate" onkeyup="alterTable(this)" value="${rate}" name="bill_rate" id="bill_rate"/>`;
      cell4.innerHTML = `<input  class="tableInput" type="number" placeholder="Discount" onkeyup="alterTable(this)" value="${discountPercent}" name="bill_discount" id="bill_discount"/>`;
      cell5.innerHTML = `<input  class="tableInput" type="number" placeholder="Tax" onkeyup="alterTable(this)" value="${taxPercent}" name="bill_tax" id="bill_tax"/>`;
      cell6.innerHTML = `<select class="w3-dropdown-hover w3-right tableInput" onchange="alterTable(this)" name="bill_tax_type" id="bill_tax_type" >
    <option class="w3-bar-item w3-button" value="1">%</option>
    <option class="w3-bar-item w3-button" value="2" default>₹</option>
  </select>`;
      cell7.innerHTML = `<input  class="tableInput" type="number" placeholder="Amount" onchange="findAmountSum()" value="${amount}" name="bill_amount" id="bill_amount"/>`;
      cell8.innerHTML = `<i class="material-icons w3-container alter delete" onclick='removeProduct("${product_detail[2]}", this)' >delete</i>`;

      cell6.querySelector("#bill_tax_type").value = taxType;
      document.getElementById("billQuantity").value = "";
      updateSubtotal(amount);
      currentProduct = "";
      selectedResult = 0;
      currentActiveList = [];
      inputField.value = "";
      inputField.focus();
    }

    function updateSubtotal(amount) {
      sub_total = parseFloat(sub_total) + parseFloat(amount);
      sub_total = sub_total.toFixed(2);
      total = sub_total;
      adjustment = document.getElementById("adjustment").value;
      if (adjustment != "") {
        total = parseFloat(total) + parseFloat(adjustment, 10);
        total = total.toFixed(2);
      }

      if (sub_total == 0)
        document.getElementById("subtotal").innerHTML = `<b>0.00</b>`;
      else
        document.getElementById("subtotal").innerHTML = `<b>${sub_total}</b>`;
      if (total == 0)
        document.getElementById("total").innerHTML = `<b>0.00</b>`;
      else document.getElementById("total").innerHTML = `<b>${total}</b>`;
    }

    function alterTable(el) {
      let row = el.parentNode.parentNode;
      let cells = row.cells;

      let quantity = cells[1].querySelector("input").value;
      let rate = cells[2].querySelector("input").value;
      let discountPercent = cells[3].querySelector("input").value;
      let taxPercent = cells[4].querySelector("input").value;
      let taxType = cells[5].querySelector("#bill_tax_type").value;
      //Amount calculation
      if (taxPercent == "") taxType = 0;
      let amount = calcAmount(
        rate,
        discountPercent,
        taxPercent,
        quantity,
        taxType
      );
      cells[6].querySelector("input").value = amount;
      findAmountSum();
    }

    function removeProduct(product, el) {
      //let rows = table.rows;
      if (confirm(`Are you sure you want to remove this product ${product}`)) {
        let row = el.parentNode.parentNode;
        let rowIndex = row.rowIndex;
        activeProductId.splice(rowIndex - 1, 1);
        updateSubtotal(row.cells[6].querySelector("input").value * -1);
        row.parentNode.removeChild(row);
      }
    }

    function addToProductSearch(product) {
      currentProduct = product;
      searchList.style.display = "none";
      var input = document.getElementById("myInput");
      let firstIndex = product.indexOf("@");
      let secondIndex = product.indexOf("@", firstIndex + 1);
      let thirdIndex = product.indexOf("@", secondIndex + 1);
      let product_name = product.substring(secondIndex + 1, thirdIndex);
      productSelector = 1;
      input.value = product_name;
    }

    var currentActiveList = [];
    document
      .getElementById("myInput")
      .addEventListener("keyup", function (event) {
        activeChildrenCount = 0;
        productSelector = 0;
        var input, filter, ul, li, a, i, txtValue;
        input = document.getElementById("myInput");

        if (input.value != "") {
          searchList.style.display = "block";
        } else {
          searchList.style.display = "none";
        }
        filter = input.value.toUpperCase();
        ul = searchList;
        li = ul.getElementsByTagName("li");
        for (i = 0; i < li.length; i++) {
          a = li[i].getElementsByTagName("a")[0];
          txtValue = a.textContent || a.innerText;
          if (txtValue.toUpperCase().indexOf(filter) > -1) {
            li[i].style.display = "";
            activeChildrenCount++;
            currentActiveList.push(i);
          } else {
            li[i].style.display = "none";
          }
        }
        if (event.keyCode != 40 && event.keyCode != 38 && event.keyCode != 13) {
          //alert(`${event.keyCode},active child ${activeChildrenCount}`);
          selectedResult = 0;
          currentActiveList = [];
          highlightResult(-1);
        }

        if (event.keyCode === 40) {
          // down arrow key
          if (selectedResult < activeChildrenCount) {
            selectedResult++;
          }
          //alert(`${selectedResult}highlight`)
          highlightResult(currentActiveList[selectedResult - 1]);
        } else if (event.keyCode === 38) {
          // up arrow key
          if (selectedResult > 1) {
            selectedResult--;
          }
          //alert(`${selectedResult}highlight`)
          highlightResult(currentActiveList[selectedResult - 1]);
        } else if (event.keyCode === 13) {
          loadValue(currentActiveList[selectedResult - 1]);
        }
        // alert(activeChildrenCount)
      });

    function loadValue(index) {
      let cur = searchList.children[index].firstElementChild.click();
      searchList.style.display = "none";
    }

    function highlightResult(index) {
      //alert(index)
      for (let i = 0; i < searchList.children.length; i++) {
        searchList.children[i].classList.remove("highlight");
      }
      searchList.children[index].classList.add("highlight");
    }

    function billProducts() {
      if (confirm("Are you sure you want to bill products?")) {
        tableValue = [];
        let rows = table.rows;
        for (let i = 1; i < rows.length; i++) {
          row = {};
          row["productId"] = activeProductId[i - 1];
          row["serial_no"] = i;
          row["product_name"] = rows[i].cells[0].querySelector("input").value;
          row["quantity"] = rows[i].cells[1].querySelector("input").value;
          row["rate"] = rows[i].cells[2].querySelector("input").value;
          row["discount"] = rows[i].cells[3].querySelector("input").value;
          row["tax"] = rows[i].cells[4].querySelector("input").value;
          row["tax_type"] =
            rows[i].cells[5].querySelector("#bill_tax_type").value;
          row["amount"] = rows[i].cells[6].querySelector("input").value;
          tableValue.push(row);
        }

        let customer = document.getElementById("customer_name").value;
        let ad_val = adjustment;
        if (adjustment == "") ad_val = 0;

        const data = {
          tableValue,
          sub_total,
          total,
          ad_val,
          customer,
        };

        fetch("/bill", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(data),
        })
          .then(handleError)
          .then((res) => {
            console.log(res);
            modal2.style.display = "none";
            aler.style.display = "block";
            aler.style.background = "green";
            text.style.display = "block";
            msg = "<strong>Success </strong>   Bill Added Successfully";
            text.innerHTML = msg;
            setTimeout(() => {
              location.reload();
            }, 1500);
          })
          .catch((err) => {
            console.log(err);
            modal2.style.display = "none";
            aler.style.display = "block";
            text.style.display = "block";
            msg = "<strong>Danger !</strong>    " + err;
            text.innerHTML = msg;
          });
      }
    }

    function findAmountSum() {
      sub_total = 0.0;
      total = 0.0;
      let rows = table.rows;
      for (let i = 1; i < rows.length; i++) {
        sub_total =
          sub_total + parseFloat(rows[i].cells[6].querySelector("input").value);
      }
      updateSubtotal(0);
    }

    window.onclick = function (event) {
      if (
        event.target == modal1 ||
        event.target == modal2 ||
        event.target == modal3
      ) {
        modal1.style.display = "none";
        modal2.style.display = "none";
        modal3.style.display = "none";
      }
    };
  </script>
</html>
